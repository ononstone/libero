window.IOL=window.IOL||{};window.IOL.EVNT=window.IOL.EVNT||{};window.IOL.EVNT.evMngrCls=function(eventServerUrl){var self=this;if(eventServerUrl&&eventServerUrl.indexOf("/v1")){eventServerUrl=eventServerUrl.replace("/v1","/v3");}
if(eventServerUrl&&eventServerUrl.indexOf("/v2")){eventServerUrl=eventServerUrl.replace("/v2","/v3");}
this._urlBase=eventServerUrl||'//evnt.iol.it/v3?';this._destUrl=false;this._target=window;this.override_ref_host=false;this.override_ref_path=false;this.version="v3.0";this.doc_types={"video":1,"post":2,"editoriale":3,"foto":4,"photogallery":5,"gallery":5,"guide_foto":6,"shriek":7,"social":8,"strillo":9,"national-geo-post":10,"regional-geo-post":11,"local-geo-post":12,"reuters-post":13,"news":14,"sfoglia":15,"saz_free":16,"saz_pagante":17,"saz_privato":18,"vid_bob":19,"vid_vpiol":20,"vid_santiago":21};this.eventTypesSplits={"pgmp":false,"pgmp_bxmp":"bxmp","bxmp":"bxmp","ck":false,"pgmp_pgnf":false,"pgmp_bxmp_pgnf":"bxmp","pgnf":false};this.eventTypes={"pgmp":{"domain":"","pag_cat1":"","pag_cat2":"","pag_cat3":"","pag_id":"","doc_id":"","doc_type":0,"ref_host":"","ref_path":"","breakpoint":0,"source":"","attrs":[],"lat":0,"lon":0},"pgmp_bxmp":{"domain":"","pag_cat1":"","pag_cat2":"","pag_cat3":"","pag_id":"","doc_id":"","doc_type":0,"ref_host":"","ref_path":"","boxes_ctr_id":[],"boxes_id":[{"area":"","box":"","doc_id":""}],"breakpoint":0,"source":"","attrs":[],"lat":0,"lon":0},"bxmp":{"domain":"","pag_cat1":"","pag_cat2":"","pag_cat3":"","pag_id":"","doc_id":"","doc_type":0,"ref_host":"","ref_path":"","boxes_ctr_id":[],"boxes_id":[{"area":"","box":"","doc_id":""}],"breakpoint":0,"source":"","attrs":[],"lat":0,"lon":0},"ck":{"domain":"","pag_cat1":"","pag_cat2":"","pag_cat3":"","pag_id":"","doc_id":"","doc_type":0,"ref_host":"","ref_path":"","box_ctr_id":"","page":"","area":"","box":"","link_type":"","cat1":"","cat2":"","cat3":"","dest_id":"","breakpoint":0,"source":"","attrs":[],"mappa":0,"lat":0,"lon":0},"pgmp_pgnf":{"domain":"","pag_cat1":"","pag_cat2":"","pag_cat3":"","pag_id":"","doc_id":"","doc_type":0,"ref_host":"","ref_path":"","breakpoint":0,"source":"","search":"","searchno":0,"attrs":[],"metric_type":"","metric_value":0,"lat":0,"lon":0},"pgmp_bxmp_pgnf":{"domain":"","pag_cat1":"","pag_cat2":"","pag_cat3":"","pag_id":"","doc_id":"","doc_type":0,"ref_host":"","ref_path":"","boxes_ctr_id":[],"boxes_id":[{"area":"","box":"","doc_id":""}],"breakpoint":0,"source":"","attrs":[],"search":"","searchno":0,"metric_type":"","metric_value":0,"lat":0,"lon":0},"pgnf":{"domain":"","pag_cat1":"","pag_cat2":"","pag_cat3":"","pag_id":"","doc_id":"","doc_type":0,"ref_host":"","ref_path":"","breakpoint":0,"source":"","search":"","searchno":0,"attrs":[],"metric_type":"","metric_value":0,"lat":0,"lon":0},"cntsc":{"domain":"","doc_id":"","doc_type":0,"fblike":0,"fbshare":0,"fbcomment":0,"twcount":0,"gplus":0}};this.getEventUrls=function(eventType,params){if(window.console&&window.IOL.debug){console.log("getEventUrls",eventType,params);}
if(typeof params.boxes_ctr_id==='string'){if(window.console&&window.IOL.debug){console.log("getEventUrls boxes_ctr_id atteso array trovata stringa, la converte in array");}
params.boxes_ctr_id=[params.boxes_ctr_id];}
if(typeof params.attrs==='string'){if(window.console&&window.IOL.debug){console.log("getEventUrls attrs atteso array trovata stringa, la converte in array");}
params.attrs=[params.attrs];}
var bmid=(params.boxes_ctr_id&&params.boxes_ctr_id.length||0)+(params.boxes_id&&params.boxes_id.length||0);var amid=(params.attrs&&params.attrs.length||0);var i;if(window.console&&window.IOL.debug){console.log(self.eventTypesSplits[eventType],bmid,amid);}
if(self.eventTypesSplits[eventType]&&bmid>30){if(window.console&&window.IOL.debug){console.log("suddivide l'evento in eventi box multipli");}
var boxes_ctr_id=(params.boxes_ctr_id||[]).slice();var boxes_id=(params.boxes_id||[]).slice();var slice1=true,slice2=true,step=0,ret=[];params.boxes_ctr_id=boxes_ctr_id.slice(step*30,step*30+30);params.boxes_id=boxes_id.slice(step*30,step*30+30);while(step<20&&(params.boxes_ctr_id.length>0||params.boxes_id.length>0)){ret.push(self._getEventUrls(eventType,params));if(step==0){eventType=self.eventTypesSplits[eventType];}
step++;params.boxes_ctr_id=boxes_ctr_id.slice(step*30,step*30+30);params.boxes_id=boxes_id.slice(step*30,step*30+30);};return ret;}else if(amid>30||params.multikpi){if(window.console&&window.IOL.debug){console.log("suddivide l'evento in eventi info multipli");}
var attrs=params.attrs||[];var multikpi=params.multikpi||[];var slice1=true,slice2=true,step=0,ret=[];if(typeof multikpi==='string'){if(window.console&&window.IOL.debug){console.log("getEventUrls ERROR multikpi atteso array trovata stringa.");}
return false;}
for(step=0;step<multikpi.length;step++){if(multikpi[step].attrs&&multikpi[step].attrs.length){params.attrs=multikpi[step].attrs;params.metric_type=multikpi[step].name||'';params.metric_value=multikpi[step].value||0;params.multikpi=false;ret.push(self._getEventUrls(eventType,params));multikpi.splice(step,1);step--;}}
step=0;if(multikpi.length>0){params.multikpi=multikpi.slice(step*6,step*6+6);params.attrs=attrs;}else{params.attrs=attrs.slice(step*30,step*30+30);params.multikpi=[];}
while(step<20&&(multikpi.length>0&&params.multikpi.length>0)||(multikpi.length==0&&(params.attrs.length>0))){if(params.multikpi.length>0){params.metric_type=params.multikpi[0].name||'';params.metric_value=params.multikpi[0].value||0;params.multikpi=params.multikpi.slice(1);}else if(step>0&&params.metric_type){params.metric_type="";params.metric_value="";}
ret.push(self._getEventUrls(eventType,params));step++;if(multikpi.length>0){params.multikpi=multikpi.slice(step*6,step*6+6);}else{params.attrs=attrs.slice(step*30,step*30+30);}};return ret;}else{if(window.console&&window.IOL.debug){console.log("evento singolo");}
return[self._getEventUrls(eventType,params)];}};this._getEventUrls=function(eventType,params){if(window.console&&window.IOL.debug){console.log("_getEventUrls",eventType,params);}
var eventTypeObj;if(typeof eventType==='string'){eventTypeObj=self.eventTypes[eventType];}else{if(window.console&&window.IOL.debug){console.log("_getEventUrls : wrong eventType",eventType);}
return false;}
var url=self._urlBase+'&'+eventType+'=';var iurl='';var tmp,fl;var props,sub;for(props in eventTypeObj){if(eventTypeObj.hasOwnProperty(props)){tmp=params[props]||eventTypeObj[props];switch(typeof tmp){case'string':if(props==='box_ctr_id'){if(typeof tmp!=='object'){iurl+=self.escape(tmp)+',';}else{fl=false;for(sub in tmp){if(tmp.hasOwnProperty(sub)){iurl+=(fl?';':'')+self.escape(tmp[sub]);fl=true;}}
iurl=iurl+',';}}else{iurl+=self.escape(tmp)+',';}
break;case'number':iurl+=parseFloat("0"+tmp)+',';break;case'object':fl=false;for(sub in tmp){if(tmp.hasOwnProperty(sub)){if(typeof tmp[sub]==='object'){iurl+=(fl?';':'')+self.escape(tmp[sub].area)+'|'+self.escape(tmp[sub].box)+'|'+self.escape(tmp[sub].doc_id);}else{iurl+=(fl?';':'')+self.escape(tmp[sub]);}
fl=true;}}
iurl=iurl+',';break;default:console.log("ERROR type not found! ",props);}}}
iurl=iurl.substr(0,iurl.length-1);if(window.console&&window.IOL.debug){console.log("_getEventUrls",url,iurl);}
url=url+self.escape(iurl)+"&nc="+new Date().getTime();if(params.multikpi){for(tmp=0;tmp<params.multikpi.length;tmp++){url+="&r="+/[a-zA-Z0-9\-\_]+/g.exec(params.multikpi[tmp].name)+"|"+/[0-9]+/g.exec(params.multikpi[tmp].value);}}
return url;};this.escape=function(txt){try{return encodeURIComponent(txt||'').replace(/\'/g,"%27");}catch(e){return escape(txt);}};this.sendEvents=function(urls,callback){if(window.console&&window.IOL.debug)window.console.log("sendEvents",urls,callback);var ret=true;callback=callback||false;var mergeCallback=false;if(callback!==false){mergeCallback=(function(no,callback){var cnt=0;return function(){cnt++;if(window.console&&window.IOL.debug){console.log("sent event no",cnt);}
if(cnt>=no){if(window.console&&window.IOL.debug){console.log("call callback",cnt);}
callback();}};}(urls.length,callback));}
var urlno;for(urlno in urls){if(urls.hasOwnProperty(urlno)){ret|=self.remoteCall(urls[urlno],mergeCallback);}}};this.pageImpression=function(domain,pag_id,doc_id,doc_type,breakpoint,attrs,callback,pag_cat1,pag_cat2,pag_cat3,lat,lon){callback=callback||false;self.sendEvents(self.getEventUrls("pgmp",{"domain":domain||self.eventTypes.pgmp.domain,"pag_id":pag_id||self.eventTypes.pgmp.pag_id,"doc_id":doc_id||self.eventTypes.pgmp.doc_id,"doc_type":doc_type||self.eventTypes.pgmp.doc_type,"breakpoint":breakpoint||self.eventTypes.pgmp.breakpoint,"ref_host":self.override_ref_host||self.getHostFromUrl(document.referrer)||self.eventTypes.pgmp.ref_host,"ref_path":self.override_ref_path||self.getPathFromUrl(document.referrer)||self.eventTypes.pgmp.ref_path,"attrs":attrs||self.eventTypes.pgmp.attrs,"lat":lat||self.eventTypes.ck.lat,"lon":lon||self.eventTypes.ck.lon,"pag_cat1":pag_cat1||self.eventTypes.ck.pag_cat1,"pag_cat2":pag_cat2||self.eventTypes.ck.pag_cat2,"pag_cat3":pag_cat3||self.eventTypes.ck.pag_cat3}),callback);return false;};this.pageAndBoxesImpression=function(domain,pag_id,doc_id,doc_type,breakpoint,attrs,boxes_ctr_id,boxes_id,callback,pag_cat1,pag_cat2,pag_cat3,lat,lon){callback=callback||false;self.sendEvents(self.getEventUrls("pgmp_bxmp",{"domain":domain||self.eventTypes.pgmp.domain,"pag_id":pag_id||self.eventTypes.pgmp.pag_id,"doc_id":doc_id||self.eventTypes.pgmp.doc_id,"doc_type":doc_type||self.eventTypes.pgmp.doc_type,"breakpoint":breakpoint||self.eventTypes.pgmp.breakpoint,"ref_host":self.override_ref_host||self.getHostFromUrl(document.referrer)||self.eventTypes.pgmp.ref_host,"ref_path":self.override_ref_path||self.getPathFromUrl(document.referrer)||self.eventTypes.pgmp.ref_path,"attrs":attrs||self.eventTypes.pgmp.attrs,"boxes_ctr_id":boxes_ctr_id||self.eventTypes.pgmp.boxes_ctr_id,"boxes_id":boxes_id||self.eventTypes.pgmp.boxes_id,"lat":lat||self.eventTypes.ck.lat,"lon":lon||self.eventTypes.ck.lon,"pag_cat1":pag_cat1||self.eventTypes.ck.pag_cat1,"pag_cat2":pag_cat2||self.eventTypes.ck.pag_cat2,"pag_cat3":pag_cat3||self.eventTypes.ck.pag_cat3}),callback);return false;};this.pageImpressionAndInfo=function(domain,pag_id,doc_id,doc_type,breakpoint,attrs,callback,info,pag_cat1,pag_cat2,pag_cat3,lat,lon){callback=callback||false;var impr={"domain":domain||self.eventTypes.pgmp.domain,"pag_id":pag_id||self.eventTypes.pgmp.pag_id,"doc_id":doc_id||self.eventTypes.pgmp.doc_id,"doc_type":doc_type||self.eventTypes.pgmp.doc_type,"breakpoint":breakpoint||self.eventTypes.pgmp.breakpoint,"ref_host":self.override_ref_host||self.getHostFromUrl(document.referrer)||self.eventTypes.pgmp.ref_host,"ref_path":self.override_ref_path||self.getPathFromUrl(document.referrer)||self.eventTypes.pgmp.ref_path,"attrs":attrs||self.eventTypes.pgmp.attrs,"lat":lat||self.eventTypes.ck.lat,"lon":lon||self.eventTypes.ck.lon,"pag_cat1":pag_cat1||self.eventTypes.ck.pag_cat1,"pag_cat2":pag_cat2||self.eventTypes.ck.pag_cat2,"pag_cat3":pag_cat3||self.eventTypes.ck.pag_cat3};for(a in info)if(info.hasOwnProperty(a))impr[a]=info[a];self.sendEvents(self.getEventUrls("pgmp_pgnf",impr),callback);return false;};this.getAClickH=function(domA,params,callback){return function(evnt){(self.getCkH(domA.href,domA.target,params.domain,params.pag_id,params.ref_host,params.ref_path,params.box_ctr_id,params.page,params['area'],params.box,params.link_type,params.cat1,params.cat2,params.cat3,params.dest_id,params.breakpoint,params.attrs,params.mappa,callback,params.pag_cat1,params.pag_cat2,params.pag_cat3,params.doc_id,params.doc_type,params.source,params.lat,params.lon))(evnt);}};this.getClickH=function(desturl,target,params,callback){return self.getCkH(desturl,target,params.domain,params.pag_id,params.ref_host,params.ref_path,params.box_ctr_id,params.page,params.area,params.box,params.link_type,params.cat1,params.cat2,params.cat3,params.dest_id,params.breakpoint,params.attrs,params.mappa,callback,params.pag_cat1,params.pag_cat2,params.pag_cat3,params.doc_id,params.doc_type,params.source,params.lat,params.lon);};this.getCkH=function(desturl,target,domain,pag_id,ref_host,ref_path,box_ctr_id,page,sarea,box,link_type,cat1,cat2,cat3,dest_id,breakpoint,attrs,mappa,callback,pag_cat1,pag_cat2,pag_cat3,doc_id,doc_type,source,lat,lon){target=target||'';callback=callback||false;return function(domClickEvent){callback=callback||false;if(domClickEvent.preventDefault)domClickEvent.preventDefault();var thew=window,cnt=0;var t=target.toLowerCase();if(t=='_ajax'){}else if(t=='_top'){}else if(t=='_parent'){}else if(t=='_blank'){thew=window.open('',t);}else if(t==''){}else{thew=window.open('',target);}
var impr={"domain":domain||self.eventTypes.ck.domain,"pag_id":pag_id||self.eventTypes.ck.pag_id,"ref_host":self.override_ref_host||self.getHostFromUrl(document.referrer)||self.eventTypes.ck.ref_host,"ref_path":self.override_ref_path||self.getPathFromUrl(document.referrer)||self.eventTypes.ck.ref_path,"box_ctr_id":box_ctr_id||self.eventTypes.ck.box_ctr_id,"page":page||self.eventTypes.ck.page,"area":sarea||self.eventTypes.ck.area,"box":box||self.eventTypes.ck.box,"link_type":link_type||self.eventTypes.ck.link_type,"cat1":cat1||self.eventTypes.ck.cat1,"cat2":cat2||self.eventTypes.ck.cat2,"cat3":cat3||self.eventTypes.ck.cat3,"dest_id":dest_id||self.eventTypes.ck.dest_id,"breakpoint":breakpoint||self.eventTypes.ck.breakpoint,"attrs":attrs||self.eventTypes.ck.attrs,"mappa":mappa||self.eventTypes.ck.mappa,"pag_cat1":pag_cat1||self.eventTypes.ck.pag_cat1,"pag_cat2":pag_cat2||self.eventTypes.ck.pag_cat2,"pag_cat3":pag_cat3||self.eventTypes.ck.pag_cat3,"doc_id":doc_id||self.eventTypes.ck.doc_id,"doc_type":doc_type||self.eventTypes.ck.doc_type,"source":source||self.eventTypes.ck.source,"lat":lat||self.eventTypes.ck.lat,"lon":lon||self.eventTypes.ck.lon};var timeouth=false;var gotourl=function(){if(timeouth!==false){clearTimeout(timeouth);timeouth=false;}
if(callback!==false){callback(domClickEvent,desturl,target,impr);return;}
var w=window,cnt=0;target=target||'';var t=target.toLowerCase();if(t=='_ajax'){return false;}else if(t=='_top'){while(w!=w.parent&&++cnt<50)w=w.parent;w.location.href=desturl;}else if(t=='_parent'){w.parent.location.href=desturl;}else if(t=='_blank'){thew.location.href=desturl;}else if(t==''){w.location.href=desturl;}else{thew.location.href=desturl;}}
timeouth=setTimeout(gotourl,3000);self.sendEvents(self.getEventUrls("ck",impr),gotourl);}
return false;};this.remoteCall=function(url,callback){if(window.console&&window.IOL.debug){console.log(url,callback);}
callback=callback||false;if(false&&window.Libero&&window.Libero.click&&callback===false){Libero.click({trackingUrl:url,skipCountername:true,addTimestampToUrl:false});}else{var i=new Image();callback=callback||false;if(callback!==false){i.onload=callback;i.onerror=callback;}
i.src=url;}
return true;};this.getUserAgent=function(){return navigator.userAgent;};this.getHostFromUrl=function(url){url=url||'';var re=/https?:\/\/([^\/:]+)/;return(re.exec(url)||['',''])[1];};this.getPathFromUrl=function(url){url=url||'';var re=/https?:\/\/([^\/]+)([^?]*)/;return(re.exec(url)||['','',''])[2];};this.getParameterByName=function(name){name=name.replace(/[\[]/,"\\[").replace(/[\]]/,"\\]");var regex=new RegExp("[\\?&]"+name+"=([^&#]*)");var results=regex.exec(window.location.search);return results===null?"":decodeURIComponent(results[1].replace(/\+/g," "));};window.IOL.EVNT.debugUrl=function(url){var a,i,p,x;url=url.substring(url.indexOf("v3?&")+4);a=url.substring(0,url.indexOf("="));p=decodeURIComponent(url.substring(url.indexOf("=")+1,url.indexOf("&"))).split(",");x=0;for(i in self.eventTypes[a])if(self.eventTypes[a].hasOwnProperty(i)){console.log("%c%s: %c%s","color: red;",i,"color: blue;",p[x]);x++;}};return self;};